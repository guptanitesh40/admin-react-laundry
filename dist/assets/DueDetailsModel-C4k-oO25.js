import{r as u,V as h,B as D,A as F,j as e,a as E,b as T,p as $,k as O,i as R}from"./index-DPF6S_1J.js";import{u as W}from"./useGetWorkshops-BSWlsjVT.js";const z="http://35.154.167.170:3000/admin/orders/assign-pickup",L=()=>{const[c,r]=u.useState(!1);return{assignPickupBoy:async y=>{const d=localStorage.getItem("authToken");r(!0);try{const t=await fetch(z,{method:"PATCH",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify(y)}),i=await t.json();return t.ok?(h.success(i.message,{position:"top-center"}),!0):(h.error(i.message,{position:"top-center"}),!1)}catch(t){return h.error((t==null?void 0:t.message)||"Error assignning pickupboy",{position:"top-center"}),!1}finally{r(!1)}},loading:c}},U=()=>{const[c,r]=u.useState(!1);return{assignWorkshop:async(y,d)=>{const t=localStorage.getItem("authToken");r(!0);try{const i=await fetch(`${D}/admin/orders/assign-workshop`,{method:"PATCH",headers:{Authorization:t?`Bearer ${t}`:"","Content-Type":"application/json"},body:JSON.stringify({order_ids:y,workshop_id:d})}),g=await i.json();return i.ok?(h.success(g.message,{position:"top-center"}),!0):(h.error(g.message,{position:"top-center"}),!1)}catch{return h.error("Failed to assign workshop"),!1}finally{r(!1)}},loading:c}},M=()=>{const[c,r]=u.useState(!1);return{assignBranch:async(y,d)=>{const t=localStorage.getItem("authToken");r(!0);try{const i=await fetch(`${D}/admin/orders/assign-branch`,{method:"PATCH",headers:{Authorization:t?`Bearer ${t}`:"","Content-Type":"application/json"},body:JSON.stringify({order_id:y,branch_id:d})}),g=await i.json();return i.ok?(h.success(g.message,{position:"top-center"}),!0):(h.error(g.message,{position:"top-center"}),!1)}catch{return h.error("Failed to assign branch"),!1}finally{r(!1)}},loading:c}},I="http://35.154.167.170:3000/admin/orders/assign-delivery",q=()=>{const[c,r]=u.useState(!1);return{assignDeliveryBoy:async y=>{const d=localStorage.getItem("authToken");r(!0);try{const t=await fetch(I,{method:"PATCH",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify(y)}),i=await t.json();return t.ok?(h.success(i.message,{position:"top-center"}),!0):(h.error(i.message,{position:"top-center"}),!1)}catch(t){return h.error((t==null?void 0:t.message)||"Error assigning delivery boy",{position:"top-center"}),!1}finally{r(!1)}},loading:c}},G=E().shape({pickup_boy_id:$().required("Please enter name to assign")}),Y=({orderId:c,modelOpen:r,onClose:f,setAssigned:y,orderStatus:d})=>{const{assignPickupBoy:t,loading:i}=L(),{assignDeliveryBoy:g,loading:_}=q(),{users:v,fetchUsersByRole:k}=F(),[n,o]=u.useState(""),[b,x]=u.useState(!0),[s,a]=u.useState({order_ids:c,pickup_boy_id:null,comment:""}),[l,j]=u.useState(""),p=u.useRef(null),w=u.useRef(null),[C,A]=u.useState(!1);u.useEffect(()=>{(async()=>{C&&(!n||n.trim()==="")?await k(4):n&&b&&await k(4,n)})()},[C,n,b]);const B=m=>{o(m.target.value),x(!0),m.target.value===""&&a({...s,pickup_boy_id:null})},P=m=>{const N=`${m.first_name} ${m.last_name}`;o(N),x(!1),a({...s,pickup_boy_id:m.user_id})};u.useEffect(()=>{const m=N=>{p.current&&!p.current.contains(N.target)&&w.current&&!w.current.contains(N.target)&&(x(!1),A(!1))};return document.addEventListener("mousedown",m),()=>{document.removeEventListener("mousedown",m)}},[]),u.useEffect(()=>{r||(o(""),a({order_ids:c,pickup_boy_id:null,comment:""}),j(""))},[r,c]);const S=async m=>{m.preventDefault();try{if(await G.validate(s,{abortEarly:!1}),d==="Assign Delivery boy"){const N={order_ids:s.order_ids,delivery_boy_id:s.pickup_boy_id};await g(N)}else await t(s);y(!0),f()}catch(N){N instanceof T&&j(N.errors[0])}};return r?e.jsxs("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black opacity-50",onClick:f}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg w-[400px] z-10 relative",children:[e.jsx("button",{className:"btn btn-sm btn-icon btn-light btn-outline absolute top-0 right-0 mr-5 mt-5 lg:mr-5 shadow-default",onClick:f,children:e.jsx("i",{className:"ki-filled ki-cross"})}),e.jsx("h2",{className:"text-2xl font-bold mb-6",children:d}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"relative flex flex-col flex-[0_0_40%]",children:[e.jsx("label",{htmlFor:"username",className:"block text-gray-700 text-sm font-bold mb-1",children:"Name"}),e.jsx("input",{type:"text",id:"username",ref:w,autoComplete:"off",value:n||"",onChange:B,className:"input border border-gray-300 rounded-md p-2 w-full",placeholder:"Search name...",onFocus:()=>{A(!0),x(!0)}}),v&&b&&e.jsx("ul",{ref:p,className:"absolute mt-[64px] bg-white z-10 border border-gray-300 rounded-md p-2 w-full text-sm",children:v.length>0?v.map(m=>e.jsxs("li",{className:"p-2 hover:bg-gray-100 cursor-pointer",onClick:()=>P(m),children:[m.first_name," ",m.last_name," (",m.mobile_number,")"]},m.user_id)):e.jsx("li",{className:"p-2 text-gray-500",children:"No users found"})}),e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l||" "})]}),d==="Assign Pickup Boy"&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-1",htmlFor:"comment",children:"Comment"}),e.jsx("textarea",{id:"comment",name:"comment",className:"h-20 input border border-gray-300 rounded-md p-2",rows:5,value:s.comment,onChange:m=>a({...s,comment:m.target.value})})]}),e.jsxs("div",{className:"flex mt-4",children:[e.jsx("button",{type:"submit",className:"btn btn-primary mr-2",disabled:i||_,children:"Assign"}),e.jsx("button",{type:"button",onClick:f,className:"btn btn-light",children:"Cancel"})]})]})]})]}):null},J=E().shape({option:$().required("Please select option")}),Q=({orderIds:c,workshopModalOpen:r,onClose:f,setAssigned:y,orderStatus:d})=>{const{workshops:g}=W(1,1e3),{branches:_}=O(1,1e3),{assignWorkshop:v,loading:k}=U(),{assignBranch:n}=M(),[o,b]=u.useState(),[x,s]=u.useState("");u.useEffect(()=>{r||(b(null),s(""))},[r,c]);const a=async l=>{l.preventDefault();try{await J.validate({option:o},{abortEarly:!1}),d==="Assign Workshop"?await v(c,o):await n(c,o),f(),y(!0)}catch(j){j instanceof T&&s(j.errors[0])}};return r?e.jsxs("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4",children:[e.jsx("div",{className:"fixed inset-0 bg-black opacity-50",onClick:f}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg w-[400px] z-10 relative",children:[e.jsx("button",{className:"btn btn-sm btn-icon btn-light btn-outline absolute top-0 right-0 mr-5 mt-5 lg:mr-5 shadow-default",onClick:f,children:e.jsx("i",{className:"ki-filled ki-cross"})}),e.jsx("h2",{className:"text-2xl font-bold mb-6",children:d==="Assign Workshop"?"Assign Workshop":"Assign Branch"}),e.jsxs("form",{onSubmit:a,children:[d==="Assign Workshop"?e.jsxs("div",{className:"relative flex flex-col flex-[0_0_40%]",children:[e.jsx("label",{className:"mb-2 font-semibold",htmlFor:"workshop_id",children:"Workshop"}),e.jsxs("select",{id:"workshop_id",className:"select border border-gray-300 rounded-md p-2 w-full text-sm",value:o??"",onChange:l=>b(Number(l.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select Workshop"}),(g==null?void 0:g.length)>0?g.map(l=>e.jsx("option",{value:l.workshop_id,children:l.workshop_name},l.workshop_id)):e.jsx("option",{children:"No Data available"})]}),e.jsx("p",{className:"text-red-500 text-sm mt-1",children:x||" "})]}):e.jsxs("div",{className:"relative flex flex-col flex-[0_0_40%]",children:[e.jsx("label",{className:"mb-2 font-semibold",htmlFor:"branch_id",children:"Branch"}),e.jsxs("select",{id:"branch_id",className:"select border border-gray-300 rounded-md p-2 w-full text-sm",value:o??"",onChange:l=>b(Number(l.target.value)),children:[e.jsx("option",{value:"",disabled:!0,children:"Select Branch"}),(_==null?void 0:_.length)>0?_.map(l=>e.jsx("option",{value:l.branch_id,children:l.branch_name},l.branch_id)):e.jsx("option",{children:"No Data available"})]}),e.jsx("p",{className:"text-red-500 text-sm mt-1",children:x||" "})]}),e.jsxs("div",{className:"flex mt-4",children:[e.jsx("button",{type:"submit",className:"btn btn-primary mr-2",disabled:k,children:"Assign"}),e.jsx("button",{type:"button",onClick:f,className:"btn btn-light",children:"Cancel"})]})]})]})]}):!1},H=()=>{const[c,r]=u.useState(!1);return{payDue:async y=>{const d=localStorage.getItem("authToken");if(!d)return h.error("Authentication token is missing!",{position:"top-center"}),{success:!1};r(!0);try{const t=await fetch(`${D}/orders/payments/pay-due`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify({orders:y})}),i=await t.json();if(!t.ok)throw new Error((i==null?void 0:i.message)||"Failed to process payment.");return h.success("Order status updated successfully",{position:"top-center"}),{success:!0,data:i}}catch(t){return h.error(t.message,{position:"top-center"}),{success:!1,error:t.message}}finally{r(!1)}},loading:c}},X=({orders:c,onClose:r,onSuccess:f})=>{R();const{payDue:y,loading:d}=H(),[t,i]=u.useState([]),[g,_]=u.useState({}),v=async()=>{if(Object.keys(g).length>0){h.error("Please fix errors before submitting.");return}const n=11,o=t.map(({order_id:x,current_paid:s,payment_status:a,kasar_amount:l,user_id:j})=>({order_id:x,paid_amount:s,payment_status:a,kasar_amount:l,order_status:n,user_id:j}));await y(o)&&f(!0)},k=(n,o,b)=>{i(x=>x.map(s=>{if(s.order_id!==n)return s;const a={...s};if(o==="kasar_amount"){const j=s.total-s.paid_amount,p=Math.min(b,j-1);if(s.current_paid===0)a.kasar_amount=p;else{a.kasar_amount=p;const w=s.total-(s.paid_amount+p);a.current_paid=Math.max(w,0)}}else a[o]=b;const l=a.current_paid+a.kasar_amount+a.paid_amount;return l>a.total?_(j=>({...j,[n]:"Paid amount cannot exceed total amount."})):_(j=>{const p={...j};return delete p[n],p}),l===a.total?a.payment_status=2:l>0?a.payment_status=3:a.payment_status=1,a}))};if(u.useEffect(()=>{c.length>0&&i(c.map(n=>{var b,x;const o=n.total-(n.paid_amount+n.kasar_amount);return{user:n.user,user_id:n.user_id,order_id:n.order_id,total:n.total,paid_amount:n.paid_amount,kasar_amount:n.kasar_amount,current_paid:o,payment_status:2,total_items:((b=n.items)==null?void 0:b.length)||0,total_quantity:((x=n.items)==null?void 0:x.reduce((s,a)=>s+a.quantity,0))||0}}))},[c]),!c.length){h.error("Order not found."),r();return}return e.jsxs("div",{className:"fixed inset-0 z-50 p-4 grid place-items-center overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black opacity-50",onClick:r}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-lg w-[700px] z-10 relative",children:[e.jsx("button",{className:"btn btn-sm btn-icon btn-light btn-outline absolute top-0 right-0 mr-5 mt-5 lg:mr-5 shadow-default",onClick:r,children:e.jsx("i",{className:"ki-filled ki-cross"})}),e.jsx("h2",{className:"text-xl font-bold mb-6",children:"Order Due Summary"}),e.jsx("div",{className:"flex flex-col gap-4 max-h-[500px] overflow-y-auto",children:t.map(n=>{const{order_id:o,user_id:b,user:x,total:s,paid_amount:a,total_items:l,total_quantity:j,kasar_amount:p,current_paid:w,payment_status:C}=n,{first_name:A,last_name:B,mobile_number:P}=x;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"py-2 px-4 border-b border-gray-200 flex justify-between gap-4 items-center",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("a",{href:`/order/${o}`,target:"__blank",className:"text-base font-bold link",children:["#",o]}),e.jsx("a",{href:`/customer/${b}`,target:"_blank",className:"text-primary text-sm font-semibold cursor-pointer",children:`${A} ${B} (${P})`})]}),e.jsx("div",{className:"flex flex-col gap-1",children:s===a+p?e.jsx("p",{className:"badge-outline badge badge-info justify-self-start",children:"Payement Received"}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"form-label !text-red-500 !font-bold",children:"Total Due Amount"}),e.jsx("p",{className:"form-label justify-center !text-red-500 !font-bold",children:s-a-p})]})})]}),e.jsx("div",{className:"py-3 px-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-stretch gap-3",children:[e.jsxs("div",{className:"basis-[225px] grid grid-cols-2 gap-y-2 items-center gap-x-4",children:[e.jsx("p",{className:"form-label",children:"Total Amount"}),e.jsx("p",{className:"form-label justify-center",children:s}),e.jsx("p",{className:"form-label",children:"Paid Amount"}),e.jsx("p",{className:"form-label justify-center",children:a}),e.jsx("p",{className:"form-label",children:"Total Items"}),e.jsx("p",{className:"form-label justify-center",children:l}),e.jsx("p",{className:"form-label",children:"Total Quantity"}),e.jsx("p",{className:"form-label justify-center",children:j})]}),e.jsxs("div",{className:"grow grid grid-cols-2 gap-y-2 items-center",children:[e.jsx("label",{htmlFor:"kasar_amount",className:"form-label",children:"Kasar Amount"}),e.jsx("input",{id:"kasar_amount",className:"form-control border border-gray-400 rounded px-3 py-2 input",type:"text",value:p,autoComplete:"off",disabled:s===a+p,onChange:S=>k(o,"kasar_amount",Number(S.target.value))}),e.jsx("label",{htmlFor:"current_paid_amount",className:"form-label",children:"Current Paid"}),e.jsx("div",{children:e.jsx("input",{id:"current_paid_amount",className:"form-control border border-gray-400 rounded px-3 py-2 input",type:"text",value:w,autoComplete:"off",disabled:s===p+a,onChange:S=>k(o,"current_paid",Number(S.target.value))})}),e.jsx("label",{htmlFor:"payement_status",className:"form-label",children:"Payment Status"}),e.jsxs("select",{id:"payement_status",className:"form-select border border-gray-400 rounded px-3 py-2 select",value:C,disabled:s===p+a,onChange:S=>k(o,"payment_status",Number(S.target.value)),children:[e.jsx("option",{value:1,children:"Pending"}),e.jsx("option",{value:2,children:"Received"}),e.jsx("option",{value:3,children:"Partial received"})]})]})]}),e.jsx("div",{children:g[o]&&e.jsx("p",{className:"text-red-500 text-sm mt-1 text-right",children:g[o]})})]})})]},o)})}),e.jsxs("div",{className:"mt-4 space-x-4",children:[e.jsx("button",{type:"button",className:"btn btn-primary relative",disabled:d,onClick:v,children:d?"loading...":"Submit"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:r,children:"Cancel"})]})]})]})};export{X as D,Y as P,Q as W,q as a,L as u};
