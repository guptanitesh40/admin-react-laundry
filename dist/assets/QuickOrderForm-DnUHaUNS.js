import{a as ce,d as w,p as C,r as a,B as ie,V as _,g as ue,A as me,H as he,i as pe,j as e,L as xe,b as ge}from"./index-D7NXGV6o.js";import{u as fe}from"./useGetCompanies-CXLlkU2p.js";import{u as be,A as _e,C as ye}from"./CustomerModal-BrXjYBMU.js";import{u as ve}from"./useGetuser-CnuJRSy4.js";import"./index-C92IcP7j.js";import"./userSchema-CfXW9anm.js";const je=ce().shape({company_id:C().required("Company is required"),branch_id:C().required("Branch is required"),user_id:C().required("User is required"),username:w().trim().required("Username is required"),address_id:C().required("Address is required"),description:w().trim().nullable().max(500,"Order note must not exceed 500 characters"),payment_type:C().required("Payment type is required"),gstin:w().trim().nullable().when([],{is:u=>!!u,then:u=>u.matches(/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/,"Invalid GSTIN format")}),gst_company_name:w().trim().nullable()}),Ne=()=>{const[u,j]=a.useState([]),[m,h]=a.useState(!1);return{branches:u,loading:m,fetchBranches:async d=>{var p;if(!d)return;h(!0);const b=localStorage.getItem("authToken");try{const x=await fetch(`${ie}/branches?company_id=${d}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b}`}}),c=await x.json();if(!x.ok){_.error(c.message||"Failed to fetch branches",{position:"top-center"});return}const i=((p=c==null?void 0:c.data)==null?void 0:p.result)||[];j(i)}catch{_.error("Error fetching branches",{position:"top-center"})}finally{h(!1)}}}},Ce="http://35.154.167.170:3000",we=`${Ce}/admin/orders?quick_order_by_admin=true`,ke=()=>{const[u,j]=a.useState(!1);return{addQuickOrder:async h=>{const o=localStorage.getItem("authToken");j(!0);try{const d=await fetch(we,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify(h)});if(!d.ok){const p=await d.json();return _.error((p==null?void 0:p.message)||"Failed to place quick order",{position:"top-center"}),!1}const b=await d.json();return _.success((b==null?void 0:b.message)||"Quick order placed successfully",{position:"top-center"}),!0}catch(d){return _.error((d==null?void 0:d.message)||"Network error: Failed to fetch.",{position:"top-center"}),!1}finally{j(!1)}},loading:u}},Ie=()=>{var M;const{companies:m,loading:h}=fe(1,1e3),{branches:o,loading:d,fetchBranches:b}=Ne(),{addQuickOrder:p,loading:x}=ke(),c=ue(s=>s==null?void 0:s.user),[i,k]=a.useState(""),[S,y]=a.useState(!0),[I,H]=a.useState(!1),[Z,U]=a.useState(!1),[V,q]=a.useState(!1),[R,A]=a.useState(!1),{users:O,fetchUsersByRole:T}=me(),{address:g,fetchAddress:G}=be(),{userData:E,fetchUser:z}=ve();E==null||E.user;const F=he(),L=pe(),J=((M=F==null?void 0:F.state)==null?void 0:M.prevUrl)||"/orders",$=a.useRef(null),B=a.useRef(null),[D,P]=a.useState(!1),[f,Q]=a.useState({}),[t,l]=a.useState({company_id:null,branch_id:null,username:"",user_id:null,address_id:null,description:"",express_delivery_charges:null,express_delivery_hour:null,normal_delivery_charges:null,payment_type:1,gstin:"",gst_company_name:""});a.useEffect(()=>{const s=r=>{B.current&&!B.current.contains(r.target)&&$.current&&!$.current.contains(r.target)&&(y(!1),P(!1))};return document.addEventListener("mousedown",s),()=>{document.removeEventListener("mousedown",s)}},[]),a.useEffect(()=>{if(g!=null&&g.length){const s=g.find(r=>r.is_default)||g[0];l(r=>({...r,address_id:s?s.address_id:null}))}},[g]),a.useEffect(()=>{(async()=>{t.user_id&&(await G(t.user_id),await z(t.user_id)),R&&(await G(t.user_id),A(!1))})()},[t.user_id,R]),a.useEffect(()=>{(async()=>{D&&(!i||i.trim()==="")?(y(!0),await T(5)):i&&S&&await T(5,i)})()},[D,i,S]);const K=async s=>{s.preventDefault();try{await je.validate(t,{abortEarly:!1}),Q({});const r={...t,sub_total:0,payment_status:1,transaction_id:"",order_status:1};await p(r)&&L("/orders")}catch(r){if(r instanceof ge){const n={};r.inner.forEach(v=>{n[v.path||""]=v.message}),Q(n)}else _.error("Failed to submit the form. Please try again.")}},W=s=>{s.target.value===""&&l(r=>({...r,address_id:null,user_id:null})),k(s.target.value),y(!0)},X=s=>{const r=`${s.first_name} ${s.last_name}`;k(r),y(!1),l({...t,username:r,user_id:s.user_id})},Y=()=>{L(`${J}`)},ee=s=>{const r=s.target.value;l(n=>({...n,address_id:Number(r)}))},se=s=>{s.preventDefault(),t.user_id?U(!0):_.error("Please select the user to add address")},te=s=>{s.preventDefault(),q(!0)},re=(s,r)=>{if(s){const n=`${s.first_name} ${s.last_name}`;k(n),y(!1),l({...t,username:n,user_id:s.user_id})}r&&l(n=>({...n,address_id:r.address_id}))},ae=s=>{s&&l(r=>({...r,address_id:s.address_id}))};return a.useEffect(()=>{if(!h&&m.length>0){const s=m.find(r=>r.gst_percentage===6);s&&l({...t,company_id:s.company_id})}},[m,h]),a.useEffect(()=>{t.company_id&&b(t.company_id)},[t.company_id]),a.useEffect(()=>{var s;if(o.length>0){const r=(s=c==null?void 0:c.user_branch)==null?void 0:s[0],n=o.find(N=>N.branch_id===r),v=(n==null?void 0:n.branch_id)??o[0].branch_id;l(N=>({...N,branch_id:v}))}},[o,c]),h||d?e.jsx(xe,{}):e.jsx("div",{className:"container-fixed",children:e.jsxs("div",{className:"card max-w-5xl mx-auto bg-white shadow-md lg:!p-4 xl:!p-6 sm:!p-5 p-3.5",children:[e.jsx("div",{className:"flex",children:e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Add Quick Order"})}),e.jsxs("form",{onSubmit:K,children:[e.jsxs("div",{className:"grid md:grid-cols-2 cs1:gap-x-6 gap-x-4  gap-y-5 mt-4 grid-cols-1",children:[e.jsxs("div",{className:"md:!col-span-2 grid md:!grid-cols-2 cs1:gap-x-6 gap-x-4 items-start grid-cols-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"block text-gray-700 text-sm font-bold mb-2",htmlFor:"company_id",children:"Company"}),e.jsxs("select",{id:"company_id",className:"select border border-gray-300 rounded-md p-2 w-full text-sm",value:t.company_id||"",onChange:s=>{l({...t,company_id:s.target.value?Number(s.target.value):null})},children:[e.jsx("option",{value:"",disabled:!0,children:"Select Company"}),m.length>0?m.map(s=>e.jsx("option",{value:s.company_id,children:`${s.company_name} (${s.gst_percentage}%)`},s.company_id)):e.jsx("option",{children:"No Data available"})]}),e.jsx("p",{className:"text-red-500 text-sm",children:f.company_id||" "})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"branch",className:"!block text-gray-700 text-sm font-bold mb-2",children:"Branch"}),e.jsxs("select",{id:"branch",className:"select border border-gray-300 rounded-md p-2 w-full text-sm",value:t.branch_id||"",onChange:s=>l({...t,branch_id:s.target.value?Number(s.target.value):null}),children:[e.jsx("option",{value:"",disabled:!0,children:"Select Branch"}),o.length>0?o.map(s=>e.jsx("option",{value:s.branch_id,children:s.branch_name},s.branch_id)):e.jsx("option",{children:"No Data Available"})]}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.branch_id||" "})]})]}),e.jsxs("div",{className:"relative col-span-1",children:[e.jsxs("span",{className:"flex justify-between items-center",children:[e.jsx("label",{htmlFor:"username",className:"block text-gray-700 text-sm font-bold mb-2",children:"Customer name"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-primary -mt-6 sm:btn-lg",onClick:te,children:"Add Customer"})]}),e.jsx("input",{type:"text",id:"username",ref:$,autoComplete:"off",value:i||"",onChange:W,className:"input border border-gray-300 rounded-md p-2 w-full",placeholder:"Search customer...",onFocus:()=>{P(!0),y(!0)}}),O&&S&&e.jsx("ul",{ref:B,className:"absolute -mt-2 bg-white border z-10 border-gray-300 rounded-md p-2 w-full text-sm max-h-[400px] overflow-y-auto",children:O.length>0?O.map(s=>e.jsxs("li",{className:"p-2 hover:bg-gray-200 cursor-pointer rounded",onClick:()=>X(s),children:[s.first_name," ",s.last_name," (",s.mobile_number,")"]},s.user_id)):e.jsx("li",{className:"p-2 text-gray-500",children:"No users found"})}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.username||" "})]}),e.jsxs("div",{className:"relative col-span-1",children:[e.jsxs("span",{className:"flex justify-between items-center",children:[e.jsx("label",{htmlFor:"address",className:"block text-gray-700 text-sm font-bold mb-2",children:"Customer address"}),e.jsx("button",{type:"button",className:"btn btn-sm btn-primary -mt-6",onClick:se,children:"Add address"})]}),e.jsxs("select",{id:"address",value:t.address_id??"",onChange:ee,className:"select border border-gray-300 rounded-md w-full text-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"Select Address"}),g.length>0&&i?g.map(s=>{const{building_number:r,area:n,landmark:v,city:N,state:le,country:ne,pincode:de}=s,oe=[r,n,v,N,le,ne,de].filter(Boolean).join(", ");return e.jsx("option",{value:s.address_id,children:oe},s.address_id)}):e.jsx("option",{disabled:!0,children:"No Address Available"})]}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.address_id||" "})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 cs1:!gap-6 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-gray-700 text-sm font-bold mb-2",children:"Order Note"}),e.jsx("textarea",{rows:3,id:"description",value:t.description,onChange:s=>l({...t,description:s.target.value}),className:"h-full input border border-gray-300 rounded-md p-2 w-full"}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.description||" "})]})}),e.jsx("div",{className:"flex flex-col md:!col-span-2",children:e.jsxs("div",{className:"md:!col-span-2 grid sm:!grid-cols-3 cs1:!gap-6 gap-4 grid-cols-1",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"exp_delivery_time",className:"block text-gray-700 text-sm font-bold mb-2",children:"Express Delivery Time"}),e.jsxs("select",{className:"select border border-gray-300 rounded-md p-2 w-full text-sm",id:"exp_delivery_time",value:t.express_delivery_hour||"",onChange:s=>s.target.value?l({...t,express_delivery_hour:Number(s.target.value),normal_delivery_charges:null}):l({...t,express_delivery_charges:null,express_delivery_hour:null}),children:[e.jsx("option",{value:"",children:"Select Express Delivery Time"}),e.jsx("option",{value:24,children:"24 Hrs"}),e.jsx("option",{value:48,children:"48 Hrs"}),e.jsx("option",{value:72,children:"72 Hrs"})]})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"express_delivery_charges",className:"block text-gray-700 text-sm font-bold mb-2",children:"Express Delivery Charge"}),e.jsx("input",{type:"text",id:"express_delivery_charges",autoComplete:"off",min:"0",value:t.express_delivery_charges||"",onChange:s=>l({...t,express_delivery_charges:s.target.value?Number(s.target.value):null}),className:`${t.normal_delivery_charges>0?"input border border-gray-300 rounded-md p-2 bg-gray-100 cursor-not-allowed focus:outline-none":"input border border-gray-300 rounded-md p-2"}`,readOnly:t.normal_delivery_charges>0})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"normal_delivery_charges",className:"block text-gray-700 text-sm font-bold mb-2",children:"Normal Delivery Charge"}),e.jsx("input",{type:"text",id:"normal_delivery_charges",min:"0",autoComplete:"off",value:t.normal_delivery_charges||"",onChange:s=>l({...t,normal_delivery_charges:s.target.value?Number(s.target.value):null}),className:`${!(t!=null&&t.express_delivery_charges)&&!(t!=null&&t.express_delivery_hour)?"input border border-gray-300 rounded-md p-2":"input border border-gray-300 rounded-md p-2 bg-gray-100 !cursor-not-allowed !focus:outline-none"}`,readOnly:!!(t!=null&&t.express_delivery_charges)||!!(t!=null&&t.express_delivery_hour)})]})]})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"payment_method",className:"block text-gray-700 text-sm font-bold mb-2",children:"Payment Method"}),e.jsxs("select",{className:"select border border-gray-300 rounded-md p-2 w-full text-sm",id:"payment_method",value:t.payment_type??"",onChange:s=>l({...t,payment_type:Number(s.target.value)}),children:[e.jsx("option",{value:"",disabled:!0,children:"Select Payment Type"}),e.jsx("option",{value:1,children:"Cash on Delivery"}),e.jsx("option",{value:2,children:"Online Payment"})]}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.payment_type||" "})]}),e.jsxs("div",{className:"flex flex-col justify-center items-start",children:[e.jsx("label",{htmlFor:"have_gst_cb",className:"block text-gray-700 text-sm font-bold mb-2",children:"Do you have GSTIN ?"}),e.jsx("input",{className:"checkbox",id:"have_gst_cb",name:"check",type:"checkbox",checked:I,onChange:s=>{H(s.target.checked)}})]}),I&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"gstin",className:"block text-gray-700 text-sm font-bold mb-2",children:"GSTIN"}),e.jsx("input",{type:"text",id:"gstin",autoComplete:"off",value:t.gstin,onChange:s=>l({...t,gstin:s.target.value}),className:"uppercase input border border-gray-300 text-sm text-gray-600 rounded-md p-2 focus:outline-none"}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.gstin||" "})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{htmlFor:"gst_company_name",className:"block text-gray-700 text-sm font-bold mb-2",children:"Company Name"}),e.jsx("input",{type:"text",id:"gst_company_name",autoComplete:"off",value:t.gst_company_name,onChange:s=>l({...t,gst_company_name:s.target.value}),className:"input border border-gray-300 text-sm text-gray-600 rounded-md p-2 focus:outline-none"}),e.jsx("p",{className:"w-full text-red-500 text-sm",children:f.gst_company_name||" "})]})]})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{type:"submit",className:`btn btn-primary ${x?"opacity-50 cursor-not-allowed":""}`,disabled:x,children:x?"Adding...":"Add Quick Order"}),e.jsx("button",{type:"button",onClick:Y,className:"btn btn-secondary",disabled:x,children:"Cancel"})]})]}),e.jsx(_e,{onAddressAdded:ae,isOpen:Z,setIsSubmit:A,onClose:()=>U(!1),userId:t.user_id,fullname:t.username}),e.jsx(ye,{onCustomerCreated:re,isOpen:V,setIsSubmit:A,onClose:()=>q(!1)})]})})};export{Ie as default};
