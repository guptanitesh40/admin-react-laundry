import{r as a,V as v,u as q,e as I,j as e,T as z,o as M,s as U,b as J}from"./index-2ZTwDx-K.js";import{u as K}from"./useGetCategories-DBNyhyax.js";import{u as H}from"./useGetProducts-BtqM_Tce.js";import{u as Q}from"./useGetServices-BB36cb_P.js";import{u as W}from"./useGetPrice-BufebFcz.js";const X="http://35.154.167.170:3000/prices",Y=()=>{const[g,n]=a.useState(!1);return{addPrice:async l=>{const p=localStorage.getItem("authToken");if(l.length===0)return v.error("No changes detected. Please provide a price to save.",{position:"top-center"}),!1;n(!0);try{const o={prices:l},m=await fetch(X,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify(o)});if(!m.ok){const x=(await m.json()).message;return v.error(x,{position:"top-center"}),!1}const h=await m.json();return v.success(h.message,{position:"top-center"}),!0}catch(o){return o.name==="TypeError"&&o.message.includes("Failed to fetch")?v.error("Network error: Failed to fetch.",{position:"top-center"}):v.error("An unexpected error occurred.",{position:"top-center"}),!1}finally{n(!1)}},loading:g}},Z=({isSave:g,setIsSave:n,setIsLoading:j,search:l})=>{const{categories:p}=K(1,1e3),{products:o}=H(1,1e3),{services:m}=Q(1,1e3),{prices:h,loading:N,fetchPrices:x}=W(),{addPrice:y,loading:C}=Y(),[c,S]=a.useState({}),[k,P]=a.useState(new Set),E=a.useRef({}),[ee,A]=q(),[i,R]=a.useState(null),[f,$]=a.useState(null),{hasPermission:w}=I(),_=a.useCallback((r,t,s,d)=>{const u=[];return r.forEach(L=>{t.forEach(F=>{s.forEach(T=>{const V=`${L.category_id}_${F.product_id}_${T.service_id}`;u.push({category:L,product:F,service:T,price:d[V]||0})})})}),u},[p,o,m,h])(p,o,m,h),D=_.filter(r=>{const t=(l||"").trim().toLowerCase();return r.category.name.toLowerCase().includes(t)||r.product.name.toLowerCase().includes(t)||r.service.name.toLowerCase().includes(t)}).sort((r,t)=>["category","product","service"].includes(i)?f==="ASC"?r[i].name.localeCompare(t[i].name):t[i].name.localeCompare(r[i].name):i==="price"?f==="ASC"?r.price-t.price:t.price-r.price:0);a.useEffect(()=>{if(g){if(!_.some(s=>{const d=`${s.category.category_id}_${s.product.product_id}_${s.service.service_id}`;return c[d]!==void 0&&c[d]!==s.price})){n(!1);return}const t=_.map(s=>{const d=`${s.category.category_id}_${s.product.product_id}_${s.service.service_id}`;return{category_id:s.category.category_id,product_id:s.product.product_id,service_id:s.service.service_id,price:c[d]!==void 0?c[d]:s.price}}).filter(s=>s.price>0);try{y(t).then(()=>{x().then(()=>{S({}),P(new Set)})})}catch{v.error("Failed to save prices.")}}n(!1)},[g,y,_,c]),a.useEffect(()=>{var t;const r=Array.from(k);if(r.length>0){const s=r[0];E.current[s]&&((t=E.current[s])==null||t.focus())}},[k]),a.useEffect(()=>{A(l?{search:l}:{})},[l]),a.useEffect(()=>{j(!!C)},[C]);const G=r=>{P(t=>{const s=new Set(t);return s.add(r),s})},O=(r,t)=>{S(s=>({...s,[r]:t}))},b=r=>{i===r?$(f==="ASC"?"DESC":"ASC"):(R(r),$("ASC"))},B=r=>{P(t=>{const s=new Set(t);return s.delete(r),s})};return N?e.jsx("div",{className:"grid gap-5 lg:gap-7.5",children:e.jsx("div",{className:"card card-grid min-w-full",children:e.jsx(z,{isFilters:!0,columns:5,records:20,isPagination:!1})})}):e.jsx(e.Fragment,{children:e.jsx("div",{className:"grid gap-5 lg:gap-7.5 mt-4",children:e.jsx("div",{className:"card card-grid min-w-full",children:e.jsx("div",{className:"card-body",children:e.jsx("div",{"data-datatable":"true","data-datatable-page-size":"10",children:e.jsx("div",{className:"scrollable-x-auto",children:e.jsxs("table",{className:"table table-auto table-border","data-datatable-table":"true",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"min-w-[40px]",children:"Id"}),e.jsx("th",{className:"min-w-[250px]",children:e.jsxs("span",{className:`sort ${i==="category"?f==="ASC"?"asc":"desc":""}`,onClick:()=>b("category"),children:[e.jsx("span",{className:"sort-label",children:"Category"}),e.jsx("span",{className:"sort-icon"})]})}),e.jsx("th",{className:"min-w-[250px]",children:e.jsxs("span",{className:`sort ${i==="product"?f==="ASC"?"asc":"desc":""}`,onClick:()=>b("product"),children:[e.jsx("span",{className:"sort-label",children:"Product"}),e.jsx("span",{className:"sort-icon"})]})}),e.jsx("th",{className:"min-w-[250px]",children:e.jsxs("span",{className:`sort ${i==="service"?f==="ASC"?"asc":"desc":""}`,onClick:()=>b("service"),children:[e.jsx("span",{className:"sort-label",children:"Service"}),e.jsx("span",{className:"sort-icon"})]})}),e.jsx("th",{className:"min-w-[200px]",children:e.jsxs("span",{className:`sort ${i==="price"?f==="ASC"?"asc":"desc":""}`,onClick:()=>b("price"),children:[e.jsx("span",{className:"sort-label",children:"Price"}),e.jsx("span",{className:"sort-icon"})]})})]})}),e.jsx("tbody",{children:D.length>0?D.map((r,t)=>{const s=`${r.category.category_id}_${r.product.product_id}_${r.service.service_id}`,d=k.has(s);return e.jsxs("tr",{className:`font-semibold ${r.price?"":"text-red-500"}`,children:[e.jsx("td",{children:t+1}),e.jsx("td",{children:r.category.name}),e.jsx("td",{children:r.product.name}),e.jsx("td",{children:r.service.name}),e.jsx("td",{className:"relative",children:d?e.jsx("input",{ref:u=>E.current[s]=u,type:"text",className:"w-full h-full absolute inset-0 input input-bordered",value:c[s]!==void 0?c[s]:r.price||"",onChange:u=>O(s,u.target.value===""?0:Number(u.target.value)),onBlur:()=>B(s),onKeyDown:u=>{u.key==="Enter"&&n(!0)}}):e.jsx("span",{className:`${w(10,"update")||w(10,"create")?"cursor-pointer h-full flex":"h-full flex"}`,onClick:w(10,"update")||w(10,"create")?()=>G(s):void 0,children:c[s]!==void 0?c[s]:r.price||"Add Price"})})]},t)}):e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"text-center",children:"No data available"})})})]})})})})})})})},ne=()=>{const[g,n]=a.useState(!1),[j,l]=a.useState(!1),[p,o]=a.useState(""),[m,h]=a.useState(""),[N,x]=a.useState(""),{hasPermission:y}=I(),C=async c=>{c.preventDefault();try{await U.validate({search:p},{abortEarly:!1}),h(p),x("")}catch(S){S instanceof J&&x(S.errors[0])}};return e.jsxs("div",{className:"px-10 max-h-[calc(100vh-69px)] flex flex-col relative",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-5 py-3 sticky-save-header",children:[e.jsx("div",{className:"flex flex-col justify-center gap-2",children:e.jsx("h1",{className:"text-xl font-semibold leading-none text-gray-900",children:"Price"})}),e.jsxs("div",{className:"flex justify-between items-start gap-3",children:[e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("form",{onSubmit:C,className:"flex items-center gap-2",children:e.jsxs("label",{className:"input input-sm h-10 flex items-center gap-2",children:[e.jsx("input",{type:"search",value:p,onChange:c=>{o(c.target.value),c.target.value===""&&(h(""),x(""))},placeholder:"Search...",className:"min-w-[185px]"}),e.jsx("button",{type:"submit",className:"btn btn-sm btn-icon",children:e.jsx("i",{className:"ki-filled ki-magnifier"})})]})}),N&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:N||"Â "})]}),(y(10,"create")||y(10,"update"))&&e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsx("button",{onClick:()=>n(!0),className:"btn btn-primary",disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ki-filled ki-plus-squared"})," Saving"," ",e.jsx(M,{})]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ki-filled ki-plus-squared"})," Save"]})})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto new-scollbar -mr-4 pr-2",children:e.jsx(Z,{isSave:g,setIsSave:n,setIsLoading:l,search:m})})]})};export{ne as default};
